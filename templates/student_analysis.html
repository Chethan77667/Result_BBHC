<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Analysis - Semester Result Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                        }
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 min-h-screen overflow-y-auto">
    <!-- ======================== MAIN PAGE HEADER SECTION ======================== -->
    <header class="bg-white border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 py-2 sm:py-3 flex flex-col md:flex-row md:items-center md:gap-4 gap-2">
            <!-- Logo Section -->
            <div class="flex md:block items-center justify-center">
                <img 
                    src="{{ url_for('static', filename='img/logo-removebg-preview.png') }}" 
                    alt="College Logo" 
                    class="h-14 w-14 sm:h-16 sm:w-16 md:h-20 md:w-20 lg:h-24 lg:w-24 object-contain" 
                />
            </div>
            
            <!-- College Name and Subtitle Section -->
            <div class="min-w-0 text-center md:text-left flex-1">
                <h1 class="text-xl sm:text-2xl md:text-3xl font-bold text-gray-900 leading-tight md:truncate">
                    Dr. B. B. Hegde First Grade College, Kundapura
                </h1>
                <div class="h-0.5 bg-gray-300 my-1 mx-auto md:mx-0 w-11/12 md:w-full"></div>
                <p class="text-xs sm:text-sm text-gray-600">
                    A Unit of Coondapur Education Society (R)
                </p>
            </div>
            
            <!-- Back to Dashboard Link -->
            <div class="flex items-center justify-center md:justify-end">
                <a href="/" class="text-primary-600 hover:text-primary-700 font-medium">
                    <i class="fas fa-arrow-left mr-1"></i>
                    Back to Dashboard
                </a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8 pb-8">
        <!-- System Status Check -->
        {% if not processing_status.all_ready %}
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 mb-6">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle text-yellow-600 text-2xl mr-3"></i>
                    <div>
                        <h3 class="font-semibold text-yellow-900">System Not Ready</h3>
                        <p class="text-sm text-yellow-700 mb-2">
                            All result files are not ready yet. {{ processing_status.files_needing_processing }} of {{ processing_status.total_files }} files still need processing.
                        </p>
                        <p class="text-sm text-yellow-700">
                            Please contact the administrator to process the remaining Excel files before you can analyze student results.
                        </p>
                    </div>
                </div>
            </div>
        {% endif %}

        <!-- Search Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">
                <i class="fas fa-search text-primary-600 mr-2"></i>
                Search Student Results
            </h2>
            
            <div class="max-w-md mx-auto">
                <div class="mb-4">
                    <label for="usnInput" class="block text-sm font-medium text-gray-700 mb-2">
                        Enter Student USN or Roll Number
                    </label>
                    <div class="relative">
                        <input 
                            type="text" 
                            id="usnInput" 
                            placeholder="e.g., U05BB23S0037 or BCA25001"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-lg"
                            onkeypress="handleEnterKey(event)"
                            oninput="formatIdentifierInput(this)"
                            maxlength="20"
                            {% if not processing_status.all_ready %}disabled{% endif %}
                        >
                        <button 
                            onclick="searchStudent()"
                            class="absolute right-2 top-2 bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-md transition duration-200"
                            {% if not processing_status.all_ready %}disabled{% endif %}
                        >
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">
                        Format: U05BB23S0037 (12 characters) where S=BCA, M=BBA, C=BCOM
                    </p>
                </div>
                
                <div id="searchSpinner" class="hidden text-center">
                    <div class="inline-flex items-center">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-primary-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span class="text-primary-600 font-medium">Searching...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
            <div class="flex items-center">
                <i class="fas fa-exclamation-triangle text-red-600 text-xl mr-3"></i>
                <div>
                    <h4 class="font-semibold text-red-900">Error</h4>
                    <p id="errorText" class="text-sm text-red-700"></p>
                </div>
            </div>
        </div>

        <!-- Student Results -->
        <div id="studentResults" class="hidden">
            <!-- Student Header -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="text-center">
                    <div class="mb-4">
                        <i class="fas fa-user-graduate text-primary-600 text-4xl mb-2"></i>
                        <h2 id="studentName" class="text-2xl font-bold text-gray-900"></h2>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-center">
                        <div class="bg-blue-50 rounded-lg p-4">
                            <i class="fas fa-id-card text-blue-600 text-xl mb-2"></i>
                            <p class="text-sm font-medium text-blue-900">Registration Number</p>
                            <p id="studentUSN" class="text-lg font-bold text-blue-700"></p>
                        </div>
                        <div class="bg-green-50 rounded-lg p-4">
                            <i class="fas fa-graduation-cap text-green-600 text-xl mb-2"></i>
                            <p class="text-sm font-medium text-green-900">Course</p>
                            <p id="studentCourse" class="text-lg font-bold text-green-700"></p>
                        </div>
                        <div class="bg-purple-50 rounded-lg p-4">
                            <i class="fas fa-calendar text-purple-600 text-xl mb-2"></i>
                            <p class="text-sm font-medium text-purple-900">Year of Admission</p>
                            <p id="studentYear" class="text-lg font-bold text-purple-700"></p>
                        </div>
                        <div class="bg-amber-50 rounded-lg p-4">
                            <i class="fas fa-star text-amber-600 text-xl mb-2"></i>
                            <p class="text-sm font-medium text-amber-900">CGPA</p>
                            <p id="studentCGPA" class="text-lg font-bold text-amber-700">--</p>
                        </div>
                        <div class="bg-orange-50 rounded-lg p-4" style="display: none;">
                            <i class="fas fa-id-badge text-orange-600 text-xl mb-2"></i>
                            <p class="text-sm font-medium text-orange-900">Roll Number</p>
                            <p id="studentRollNo" class="text-lg font-bold text-orange-700"></p>
                        </div>
                        <div class="bg-indigo-50 rounded-lg p-4" style="display: none;">
                            <i class="fas fa-users text-indigo-600 text-xl mb-2"></i>
                            <p class="text-sm font-medium text-indigo-900">Class</p>
                            <p id="studentClass" class="text-lg font-bold text-indigo-700"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Semester Tabs -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">
                    <i class="fas fa-chart-line text-primary-600 mr-2"></i>
                    Semester Results
                </h3>
                
                <!-- Tab Navigation -->
                <div id="semesterTabs" class="flex flex-wrap border-b border-gray-200 mb-6">
                    <!-- Tabs will be dynamically generated -->
                </div>
                
                <!-- Tab Content -->
                <div id="semesterContent">
                    <!-- Content will be dynamically generated -->
                </div>
            </div>
        </div>
    </main>

    <!-- Scroll to Top Button -->
    <button 
        id="scrollToTop" 
        onclick="scrollToTop()"
        class="fixed bottom-6 right-6 bg-primary-600 hover:bg-primary-700 text-white p-3 rounded-full shadow-lg transition-all duration-300 ease-in-out transform hover:scale-110 focus:outline-none focus:ring-4 focus:ring-primary-200 opacity-0 pointer-events-none"
    >
        <i class="fas fa-arrow-up text-lg"></i>
    </button>

    <script>
        let currentStudentData = null;
        let activeTab = null;

        function handleEnterKey(event) {
            if (event.key === 'Enter') {
                searchStudent();
            }
        }

        function formatIdentifierInput(input) {
            // Convert to uppercase and limit to 20 characters
            let value = input.value.toUpperCase();
            if (value.length > 20) {
                value = value.substring(0, 20);
            }
            input.value = value;
        }

        async function searchStudent() {
            const usnInput = document.getElementById('usnInput');
            const searchSpinner = document.getElementById('searchSpinner');
            const errorMessage = document.getElementById('errorMessage');
            const studentResults = document.getElementById('studentResults');
            
            // Check if system is ready
            {% if not processing_status.all_ready %}
                showError('System is not ready. Please contact administrator to process remaining files.');
                return;
            {% endif %}
            
            const usn = usnInput.value.trim();
            if (!usn) {
                showError('Please enter a USN');
                return;
            }
            
            // Show loading
            searchSpinner.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            studentResults.classList.add('hidden');
            
            try {
                const response = await fetch('/search-student', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ usn: usn })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentStudentData = result.student_data;
                    displayStudentResults(result.student_data);
                } else {
                    showError(result.error);
                }
                
            } catch (error) {
                console.error('Error:', error);
                showError(`An error occurred while searching for the student: ${error.message}`);
            } finally {
                searchSpinner.classList.add('hidden');
            }
        }

        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function displayStudentResults(studentData) {
            console.log('Student data received:', studentData);
            console.log('Results:', studentData.results);
            
            // Update student header
            document.getElementById('studentName').textContent = studentData.name;
            document.getElementById('studentUSN').textContent = studentData.usn;
            document.getElementById('studentCourse').textContent = studentData.course;
            document.getElementById('studentYear').textContent = studentData.year;
            
            // Update CGPA in header card
            const cgpaElement = document.getElementById('studentCGPA');
            if (studentData.cgpa !== null && studentData.cgpa !== undefined && studentData.cgpa !== '') {
                cgpaElement.textContent = studentData.cgpa;
                cgpaElement.className = 'text-lg font-bold text-amber-700';
            } else {
                cgpaElement.textContent = '--';
                cgpaElement.className = 'text-lg font-bold text-amber-700';
            }
            
            // Update roll number and class if available
            const rollNoElement = document.getElementById('studentRollNo');
            const classElement = document.getElementById('studentClass');
            
            if (studentData.roll_no && rollNoElement) {
                rollNoElement.textContent = studentData.roll_no;
                rollNoElement.parentElement.style.display = 'block';
            } else if (rollNoElement) {
                rollNoElement.parentElement.style.display = 'none';
            }
            
            if (studentData.class && classElement) {
                classElement.textContent = studentData.class;
                classElement.parentElement.style.display = 'block';
            } else if (classElement) {
                classElement.parentElement.style.display = 'none';
            }
            
            // Helper function to extract semester number and format as "Sem X"
            function formatSemesterDisplay(semesterString) {
                // Extract number from semester string (handles "Sem 1", "Sem 1 2024", "SEM 1", etc.)
                const match = semesterString.match(/(?:sem|semester)\s*(\d+)/i);
                if (match && match[1]) {
                    return `Sem ${match[1]}`;
                }
                // Fallback: try to extract any number
                const numMatch = semesterString.match(/(\d+)/);
                if (numMatch && numMatch[1]) {
                    return `Sem ${numMatch[1]}`;
                }
                // Final fallback: return as is
                return semesterString;
            }
            
            // Sort results by semester number (increasing order for display)
            const sortedResults = studentData.results.sort((a, b) => {
                const aMatch = a.semester.match(/(?:sem|semester)\s*(\d+)/i);
                const bMatch = b.semester.match(/(?:sem|semester)\s*(\d+)/i);
                const aNum = aMatch ? parseInt(aMatch[1]) : 0;
                const bNum = bMatch ? parseInt(bMatch[1]) : 0;
                return aNum - bNum; // Ascending order (Sem 1, Sem 2, Sem 3)
            });
            
            // Generate semester tabs
            const tabsContainer = document.getElementById('semesterTabs');
            tabsContainer.innerHTML = '';
            
            sortedResults.forEach((result, index) => {
                console.log(`Processing result ${index}:`, result.semester);
                const tab = document.createElement('button');
                // Most recent semester (last in ascending order) gets selected by default
                const isMostRecent = index === sortedResults.length - 1;
                tab.className = `px-6 py-3 font-medium text-sm border-b-2 transition-colors ${
                    isMostRecent 
                        ? 'border-primary-500 text-primary-600 bg-primary-50' 
                        : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                }`;
                // Format semester display to show only "Sem X"
                tab.textContent = formatSemesterDisplay(result.semester);
                tab.onclick = () => switchTab(index);
                tabsContainer.appendChild(tab);
            });
            
            // Show most recent semester (last in sorted array) by default
            if (sortedResults.length > 0) {
                switchTab(sortedResults.length - 1);
            }
            
            // Show results section
            document.getElementById('studentResults').classList.remove('hidden');
            
            // Scroll to results
            document.getElementById('studentResults').scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
        }

        function switchTab(index) {
            if (!currentStudentData || !currentStudentData.results[index]) return;
            
            activeTab = index;
            
            // Helper function to extract semester number and format as "Sem X"
            function formatSemesterDisplay(semesterString) {
                const match = semesterString.match(/(?:sem|semester)\s*(\d+)/i);
                if (match && match[1]) {
                    return `Sem ${match[1]}`;
                }
                const numMatch = semesterString.match(/(\d+)/);
                if (numMatch && numMatch[1]) {
                    return `Sem ${numMatch[1]}`;
                }
                return semesterString;
            }
            
            // Get sorted results (same sorting as in displayStudentResults)
            const sortedResults = currentStudentData.results.sort((a, b) => {
                const aMatch = a.semester.match(/(?:sem|semester)\s*(\d+)/i);
                const bMatch = b.semester.match(/(?:sem|semester)\s*(\d+)/i);
                const aNum = aMatch ? parseInt(aMatch[1]) : 0;
                const bNum = bMatch ? parseInt(bMatch[1]) : 0;
                return aNum - bNum; // Ascending order (Sem 1, Sem 2, Sem 3)
            });
            
            const result = sortedResults[index];
            
            // Update tab styles
            const tabs = document.querySelectorAll('#semesterTabs button');
            tabs.forEach((tab, i) => {
                if (i === index) {
                    tab.className = 'px-6 py-3 font-medium text-sm border-b-2 border-primary-500 text-primary-600 bg-primary-50';
                } else {
                    tab.className = 'px-6 py-3 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300';
                }
            });
            
            // Update content
            const contentContainer = document.getElementById('semesterContent');
            contentContainer.innerHTML = generateSemesterContent(result);
        }

        function generateSemesterContent(result) {
            const subjectsHtml = result.subjects.map(subject => `
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                    <div class="flex justify-between items-center h-16">
                        <div class="flex-1 flex items-center">
                            <h4 class="font-semibold text-gray-900">${subject.subject}</h4>
                        </div>
                        <div class="flex items-center">
                            ${subject.status === 'Absent' ? 
                                `<p class="text-lg font-bold text-orange-600">Absent</p>` :
                                `<div class="text-center">
                                    <p class="text-lg font-bold text-primary-600">${subject.marks}</p>
                                    <p class="text-xs font-bold px-2 py-1 rounded-full border-2 shadow-sm ${subject.status.toUpperCase() === 'PASS' ? 'bg-green-500 text-white border-green-600' : subject.status.toUpperCase() === 'FAIL' ? 'bg-red-500 text-white border-red-600' : 'bg-gray-500 text-white border-gray-600'}">
                                        ${subject.status}
                                    </p>
                                </div>`
                            }
                        </div>
                    </div>
                </div>
            `).join('');
            
            return `
                <div class="space-y-6">
                    <!-- Subjects -->
                    <div>
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">Subject Results</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${subjectsHtml}
                        </div>
                    </div>
                    
                    <!-- Summary -->
                    <div class="bg-gradient-to-r from-primary-50 to-blue-50 rounded-lg p-6 border border-primary-200">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">Summary</h4>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div class="text-center">
                                <p class="text-sm font-medium text-gray-600">Total Marks</p>
                                <p class="text-xl font-bold text-primary-600">${result.summary.total_marks}</p>
                            </div>
                            <div class="text-center">
                                <p class="text-sm font-medium text-gray-600">Max Marks</p>
                                <p class="text-xl font-bold text-primary-600">${result.summary.max_marks}</p>
                            </div>
                            <div class="text-center">
                                <p class="text-sm font-medium text-gray-600">Percentage</p>
                                <p class="text-xl font-bold text-primary-600">${result.summary.percentage}%</p>
                            </div>
                            <div class="text-center">
                                <p class="text-sm font-medium text-gray-600">SGPA</p>
                                <p class="text-xl font-bold ${result.summary.sgpa === 'Not Available' ? 'text-gray-500' : 'text-green-600'}">${result.summary.sgpa}</p>
                            </div>
                            <div class="text-center">
                                <p class="text-sm font-medium text-gray-600">Result</p>
                                <p class="text-xl font-bold ${result.summary.result === 'PASS' ? 'text-green-600' : 'text-red-600'}">${result.summary.result}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Scroll to top function
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }
        
        // Show/hide scroll to top button based on scroll position
        window.addEventListener('scroll', function() {
            const scrollToTopBtn = document.getElementById('scrollToTop');
            if (window.pageYOffset > 300) {
                scrollToTopBtn.style.opacity = '1';
                scrollToTopBtn.style.pointerEvents = 'auto';
            } else {
                scrollToTopBtn.style.opacity = '0';
                scrollToTopBtn.style.pointerEvents = 'none';
            }
        });
    </script>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 mt-6">
        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8">
            <div class="text-center text-gray-500 text-sm">
                <p>&copy; 2025 Sem Result Analyzer | Developed by Incubation Center | All Rights Reserved.</p>
            </div>
        </div>
    </footer>
</body>
</html>
